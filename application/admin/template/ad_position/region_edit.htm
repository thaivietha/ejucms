{include file="public/layout" /}

<body>
<script type="text/javascript" src="__SKIN__/js/jquery-ui/jquery-ui.min.js?v={$version}"></script>
<div class="layui-fluid " id="LAY-component-layer-list">
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md12">
            <div class="layui-card web-system">
                <div class="layui-card-body layui-form">
                    <div class="layui-form-item">
                        <label class="layui-form-label"><b>*</b>广告名称</label>
                        <div class="layui-input-inline">
                            <input type="text" name="title" id="title" value="{$field.title}" readonly class="layui-input">
                        </div>
                        <div class="layui-input-inline layui-form-mid layui-word-aux ey_helptips"></div>
                        <div class="layui-form-inline2 ey_helptips_txt none" style="display: none;">保持唯一性，不可重复</div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label"><b>*</b>所属区域</label>
                        <div class="layui-input-inline w120">
                            <select name="province_id" id="province_id"  lay-filter="province_id" >
                                <option value="0">请选择省</option>
                                {eju:volist name=':get_province_list()' id='vo'}
                                <option value="{$vo.id}" {eq name="$field.province_id" value="$vo.id" } selected {/eq} >{$vo.name}</option>
                                {/eju:volist}
                            </select>
                        </div>
                        <div class="layui-input-inline w120">
                            <select name="city_id" id="city_id"   lay-filter="city_id"  lay-verify="check_cityid">
                                <option value="">请选择城市</option>
                            </select>
                        </div>
                        <div class="layui-input-inline none w120" id="area_div">
                            <select name="area_id" id="area_id">
                                <option value="">请选择区域</option>
                            </select>
                        </div>
                        <div class="layui-form-mid layui-word-aux ey_helptips"></div>
                        <div class="layui-form-inline2 ey_helptips_txt none">后台菜单>系统配置>区域管理</div>
                    </div>
                    <div class="layui-form-item ">
                        <label class="layui-form-label">广告内容</label>
                        <div class="layui-input-inline">
                            <div class="upload-box">
                                <div class="upload-right fl">
                                    <button class="layui-btn multi-upload-demoMore layui-btn-primary layui-btn-sm fl mb10 mr5" lay-data="{number:100,ey_savepath:'allimg',ey_callback:'imgupload_call_back'}"><i class="layui-icon">&#xe67c;</i>上传图片</button>
                                    <button class="layui-btn layui-btn-sm layui-btn-primary layui-btn-sm fl mb10" onClick="GetPictureFolder(100,'litpic_local','imgupload_call_back');"><i class="layui-icon">&#xe64a;</i>图库</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item ">
                        <label class="layui-form-label"></label>
                        <div class="edit-box-con2 fl sort-list">
                            <input type="hidden" id="ImagesId">
                            {volist name="ad_data" id="vo" key="k"}
                            <div class="images-upload">
                                <div class="upimg">
                                    <div class="icaction" style="display: none;">
                                            <span class="load_images"  onclick="Images('{$vo['litpic']}');">
                                                <a href="javascript:void(0);" style="color:white">
                                                    <i class="layui-icon layui-icon-search mr5"></i>查看大图
                                                </a>
                                            </span>
                                        <span class="load_images mr5 multi-upload-demoMore" lay-data="{number:1,ey_callbefore:'LoadImagesId({$vo['id']})',ey_savepath:'allimg',ey_callback:'UpdataImages'}" data-id="{$vo['id']}">
                                                <i class='fa fa-photo'></i>更换图片
                                            </span>
                                    </div>
                                    <div class="cover-bg" style="display: none"></div>
                                    <img id="{$vo['id']}_Id" src="{$vo['litpic']}" />
                                </div>
                                <input type="hidden"  name="img_id[]" value="{$vo['id']}"/>
                                <span class="span_input">
                                        <input type="hidden" id="{$vo['id']}_Litpic" name="img_litpic[]" value="{$vo['litpic']}"/>
                                    </span>
                                <textarea name="img_title[]" placeholder="请输入标题..." style="height: 28px;">{$vo.title}</textarea>
                                <textarea name="img_links[]" placeholder="请输入链接网址..." style="height: 28px;">{$vo.links}</textarea>
                                <textarea name="intro[]" placeholder="广告注释：支持HTML代码" style="height: 64px;">{$vo.intro}</textarea>
                                <div class="operation">
                                    <a href="javascript:void(0);">
                                        <label>
                                            <input lay-ignore type='checkbox' title='在新窗口打开' onclick='CheckedTarget(this)'  {eq name="$vo['target']" value="1"} checked="checked" {/eq} />新窗口
                                            <input type='hidden' name='img_target[]' value="{$vo['target']}">
                                        </label>
                                    </a>
                                    <a href="javascript:void(0);" onclick="copyToClipBoard({$vo['id']})">
                                        <i class="layui-icon layui-icon-fonts-code mr5"></i>标签调用
                                    </a>
                                    <a href="javascript:void(0)" onclick="ClearPicArr(this,'{$vo['litpic']}','{$vo['id']}')">
                                        <i class="layui-icon layui-icon-close mr5"></i>删除
                                    </a>
                                </div>
                            </div>
                            {/volist}

                            <div class="images-upload" style="display: none;"></div>
                            <!-- 上传图片显示的样板 start -->
                            <div class="images_upload_tpl" style="display: none;">
                                <div class="images-upload">
                                    <div class="upimg">
                                        <div class="icaction" style="display: none;">
                                            <span class="load_images">
                                                <a href="javascript:void(0);" style="color:white">
                                                    <i class="layui-icon layui-icon-search mr5"></i>查看大图
                                                </a>
                                            </span>
                                        </div>
                                        <div class="cover-bg" style="display: none"></div>
                                        <img src="__STATIC__/admin/images/add-button.jpg">
                                    </div>
                                    <input type="hidden"/>
                                    <span class="span_input">
                                        <input type="hidden"/>
                                    </span>
                                    <textarea placeholder="请输入标题..." style="height: 28px;"></textarea>
                                    <textarea placeholder="请输入链接网址..." style="height: 28px;"></textarea>
                                    <textarea placeholder="广告注释：支持HTML代码" style="height: 64px;"></textarea>
                                    <div class="operation">
                                        <a href="javascript:void(0);"></a>
                                        <a href="javascript:void(0);"></a>
                                        <a href="javascript:void(0);"></a>
                                    </div>
                                </div>
                            </div>
                            <!-- 上传图片显示的样板 end -->
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-input-block">
                            <input type="hidden" name="rid" value="{$field.rid}">
                            <input type="hidden" name="pid" value="{$field.pid}">
                            <button class="layui-btn" lay-submit lay-filter="formSubmit">确认提交</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // 勾选新窗口打开链接
    function CheckedTarget(t){
        if ($(t).is(':checked')) {
            $(t).parent().find('input[name="img_target[]"]').val(1);
        }else{
            $(t).parent().find('input[name="img_target[]"]').val(0);
        }
    }

    // 鼠标事件，加载查看大图和更新图片
    $(document).ready(function(){
        $(".upimg").live('mouseover', function(){
            $(this).find('div.icaction').show();
            $(this).find('div.cover-bg').show();
        }).live('mouseout', function(){
            $(this).find('div.icaction').hide();
            $(this).find('div.cover-bg').hide();
        });
        var city_id = "{$field.city_id}";
        set_city_list(city_id);
        console.log(city_id);
        var area_id = "{$field.area_id}";
        set_area_list(area_id);
    });

    // 查看大图
    function Images(links){
        var max_width = 650;
        var max_height = 350;
        var img = "<img src='"+links+"'/>";
        $(img).load(function() {
            width  = this.width;
            height = this.height;
            if (width > height) {
                if (width > max_width) {
                    width = max_width;
                }
                width += 'px';
            } else {
                width = 'auto';
            }
            if (width < height) {
                if (height > max_height) {
                    height = max_height;
                }
                height += 'px';
            } else {
                height = 'auto';
            }

            var links_img = "<img style='width:"+width+";height:"+height+";' src="+links+">";

            layer.open({
                type: 1,
                title: false,
                closeBtn: true,
                area: [width, height],
                skin: 'layui-layer-nobg', //没有背景色
                content: links_img
            });
        });
    }

    layui.config({
        base: '__SKIN__/' //静态资源所在路径
        ,version: '{$version}'
    }).extend({
        index: 'lib/index' //主入口模块
    }).use(['index', 'form',  'upload'], function(){
        var $ = layui.$
            ,upload = layui.upload
            ,form = layui.form;

        //选中省份模型
        form.on('select(province_id)', function(data){
            set_city_list(0);
            set_area_list(0);
            form.render();
        });
        //选中城市
        form.on('select(city_id)', function(data){
            set_area_list(0);
            form.render();
        });
        //监听提交
        form.on('submit(formSubmit)', function(data){
            var load = layer_loading();
            data.field._ajax = 1;
            $.ajax({
                type : 'post',
                url : "{:url('AdPosition/region_edit')}",
                data : data.field,
                dataType : 'json',
                success : function(res){
                    layer.close(load); //关闭loading
                    if(res.code == 1){
                        layer.msg(res.msg, {icon: 1, time: 1000}, function(){
                            parent.gourl(res.url);
                        });
                    }else{
                        layer.msg(data.msg, {icon: 2,time: 2000});
                    }
                },
                error: function(e){
                    layer.close(load); //关闭loading
                    showErrorAlert();
                }
            });
            return false;
        });
    });
    //自动获取城市列表
    function set_city_list(cityid) {
        var pid =  $("#province_id").val();
        $.ajax({
            url: "{:url('Region/ajax_get_region')}",
            type: 'POST',
            dataType: 'JSON',
            async: false,
            data: {pid:pid,_ajax:1},
            success: function(res){
                if (res.code === 1){
                    $("#city_id").empty();
                    $("#city_id").prepend(res.msg);
                    if (cityid > 0){
                        $("#city_id").val(cityid);
                    }
                }
            },
            error: function(e){
                showErrorMsg();
                return false;
            }
        });
    }
    //自动获取区域
    function set_area_list(areaid) {
        var pid =  $("#city_id").val();
        $.ajax({
            url: "{:url('Region/ajax_get_region')}",
            type: 'POST',
            dataType: 'JSON',
            async: false,
            data: {pid:pid,level:3,_ajax:1},
            success: function(res){
                if (res.code === 1){
                    $("#area_id").empty();
                    $("#area_id").prepend(res.msg);
                    if (areaid > 0){
                        $("#area_id").val(areaid);
                    }
                    if (res.data.isempty == 1){
                        $("#area_div").hide();
                    }else{
                        $("#area_div").show();
                    }
                }
            },
            error: function(e){
                showErrorMsg();
                return false;
            }
        });
    }
    // 获取点击更新图片的ID并加载隐藏域
    function LoadImagesId(id){
        // 加载ID到隐藏域
        $('#ImagesId').val(id);

        return true;
        // 调用图片上传JS
//        GetUploadify(1,'','allimg','UpdataImages');
    }
    // 更新图片
    function UpdataImages(pathObj){
        var path = pathObj.url;
        // 获取点击的ID
        var id = $('#ImagesId').val();
        // 加载图片到显示层
        $("#"+id+"_Id").attr('src', path);
        // 加载图片到提交的隐藏域
        $("#"+id+"_Litpic").val(path);
    }
    // 代码调用js
    function copyToClipBoard(id) {
        var adstr = "{eju:ad aid='" + id + "'}\r\n   <a href='{$"+"field.links}' {$"+"field.target}><img src='{$"+"field.litpic}' alt='{$"+"field.title}' /></a>\r\n{/eju:ad";
        var contentdiv = '<div class="dialog_content" style="margin: 0px; padding: 0px;"><dl style="padding:10px 30px;line-height:30px"><dd>标签 ad 调用:</dd>'
        contentdiv += '<textarea rows="4" cols="60" style="width:400px;height:80px;">' + adstr + '}</textarea>'
        contentdiv += '<dd style="border-top: dotted 1px #E7E7E7; color: #F60;">请将对应标签代码复制并粘贴到对应模板文件中！</dd></dl></div>'
        layer.open({
            title: '代码调用',
            type: 1,
            skin: 'layui-layer-demo',
            area: ['480px', '240px'], //宽高
            content: contentdiv
        });
    }
    // 上传图集相册回调函数
    function imgupload_call_back(pathObj){
        if (Array.isArray(pathObj)){
            var paths = pathObj;
        }else{
            var paths = [pathObj.url];
        }
        var last_div = $(".images_upload_tpl").html();
        var inputs   = $('.span_input input');

        for (var i=0;i<paths.length ;i++){
            $(".images-upload:eq(0)").before(last_div);  // 插入一个 新图片
            // 修改他的链接地址
            $(".images-upload:eq(0)").find('span:eq(0)').attr('onclick',"Images('"+paths[i]+"');");
            // 修改他的图片路径
            $(".images-upload:eq(0)").find('img').attr('src',paths[i]);
            // 处理图片路径及隐藏域
            if (inputs.length > '0') {
                // 修改隐藏域，提交ID隐藏域
                $(".images-upload:eq(0)").find('input:eq(0)').attr('name','img_id[]').attr('value','');
                // 修改隐藏域，提交图片隐藏域
                $(".span_input:eq(0)").find('input:eq(0)').attr('name','img_litpic[]').attr('value',paths[i]);
                // 提交标题
                $(".images-upload:eq(0)").find('textarea:eq(0)').attr('name','img_title[]');
                // 提交跳转链接
                $(".images-upload:eq(0)").find('textarea:eq(1)').attr('name','img_links[]');
                //提交广告简介
                $(".images-upload:eq(0)").find('textarea:eq(2)').attr('name','intro[]');
                // 提交新窗口选项
                $(".images-upload:eq(0)").find('div.operation a:eq(0)').html("<label><input lay-ignore type='checkbox' title='在新窗口打开' onclick='CheckedTarget(this)'/>新窗口<input type='hidden' name='img_target[]' value='0'></label>");
                //标签调用
                $(".images-upload:eq(0)").find('div.operation a:eq(1)').attr('onclick',"copyToClipBoard('广告ID')").html("<i class='layui-icon layui-icon-fonts-code mr5'></i>标签调用");
                // 删除按钮
                $(".images-upload:eq(0)").find('div.operation a:eq(2)').attr('onclick',"ClearPicArr(this,'"+paths[i]+"')").html("<i class='layui-icon layui-icon-close mr5'></i>删除");
            }
        }
    }
    // 上传之后删除组图input
    function ClearPicArr(obj,path,id='')
    {
        // 删除数据库记录
        $.ajax({
            type:'POST',
            url:"{:url('AdPosition/del_imgupload')}",
            data:{del_id:id},
            success:function(){
                $(obj).parent().parent().remove(); // 删除完服务器的, 再删除 html上的图片
                $.ajax({
                    type:'POST',
                    url:"{:url('Uploadify/delupload')}",
                    data:{action:"del", filename:path},
                    success:function(){}
                });
            }
        });
    }
    // 图集相册的拖动排序相关 js
    $( ".sort-list" ).sortable({
        start: function( event, ui) {

        }
        ,stop: function( event, ui ) {

        }
    });
    $( ".sort-list" ).disableSelection();

</script>
{include file="public/footer" /}
