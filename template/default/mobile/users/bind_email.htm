<!DOCTYPE html>
<html lang="zh-CN">
{include file="users/header" /}
<body style="padding-top:2.625rem ;">
<!--顶部-->
{include file="users/rightNav" /}
<!--用户设置-->
<form id="post_form" action="{:url('Users/bind_email')}" onsubmit="return false;">
<div class="fang_add mt10">
    <div class="item">
        <div class="item_l">邮箱地址：</div>
        <div class="item_r">
            <input type="text"  name="email" id="email"  value="{$users.email}"  placeholder="请输入邮箱地址" />
        </div>
    </div>
    <div class="item">
        <div class="item_l">验证码：</div>
        <div class="item_r">
            <input type="text"  name="email_code" id="email_code" value="" placeholder="请输入验证码" />
        </div>
        <div class="item_unit">
            <!--灰色按钮 bt-gray -->
            <button class="bt-green" type="button"  onclick="get_email_code();" id="email_button">点击发送</button>
        </div>
    </div>
</div>
<!--确认提交-->
<div class="footer-bt">
    <a  href="JavaScript:;"  onclick="submit_fun()">确认提交</a>
</div>
</form>
<script type="text/javascript">
    function get_email_code()
    {
        var email = $("#email").val();
        var reg = /^[a-z0-9]([a-z0-9\\.]*[-_]{0,4}?[a-z0-9-_\\.]+)*@([a-z0-9]*[-_]?[a-z0-9]+)+([\.][\w_-]+){1,5}$/i;
        // 邮箱格式不正确
        if(!reg.test(email)){
            layer.msg('请正确输入邮箱地址！', {time: 2000});
            return false;
        }
        $("#email_button").val('发送中…');
        $("#email_button").attr('disabled', 'disabled');
        var title = '{$title}';
        $.ajax({
            url: "{eju:url link='user/Smtpmail/send_email' /}",
            data: {email:email,title:title,type:'bind_email',scene:3},
            type:'post',
            dataType:'json',
            success:function(res){
                if(res.code == 1){
                    layer.msg(res.msg, {time: 2000});
                    countdown();
                }else{
                    $("#email_button").val('点击发送');
                    $("#email_button").removeAttr("disabled");
                    layer.alert(res.msg, {icon: 2});
                }
            },
            error : function() {
                $("#email_button").val('点击发送');
                $("#email_button").removeAttr("disabled");
                layer.alert('网络失败，请刷新页面后重试', {icon: 5});
            }
        });
    }
    function countdown(){
        // 倒计时
        var setTime;
        var time = {php}echo config('global.email_send_time');{/php};
        setTime = setInterval(function(){
            if(0 >= time){
                clearInterval(setTime);
                return;
            }
            time--;
            $("#email_button").html(time+'秒');
            $("#email_button").attr('disabled', 'disabled');

            if(time == 0){
                $("#email_button").html('点击发送');
                $("#email_button").removeAttr("disabled");
            }
        },1000);
    }
    function submit_fun(){
        var load = layer_loading();
        $.ajax({
            type : 'post',
            url : "{:url('Users/bind_email')}",
            data : $("#post_form").serialize(),
            dataType : 'json',
            success : function(res){
                layer.close(load); //关闭loading
                if(res.code == 1){
                    layer.msg(res.msg, {icon: 1,time: 2000});
                    parent.window.location.href = "{:url('Users/centre')}";
                }else{
                    layer.msg(res.msg, {icon: 2,time: 2000});
                }
            },
            error: function(e){
                layer.close(load); //关闭loading
                showErrorAlert();
            }
        });
        return false;
    }
</script>

</body>
</html>
