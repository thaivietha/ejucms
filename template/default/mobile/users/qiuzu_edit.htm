<!DOCTYPE html>
<html lang="zh-CN">
{include file="users/header" /}
<body style="padding-top:2.625rem ;">
<!--<script type="text/javascript" src="__PUBLIC__/plugins/Ueditor/ueditor.config.js?v={$version}"></script>-->
<!--<script type="text/javascript" src="__PUBLIC__/plugins/Ueditor/ueditor.all.js?v={$version}"></script>-->
<!--<script type="text/javascript" src="__PUBLIC__/plugins/Ueditor/lang/zh-cn/zh-cn.js?v={$version}"></script>-->
{include file="users/rightNav" /}
<form id="post_form" action="{:url('Qiuzu/add')}" onsubmit="return false;">
    <!--添加房源信息-->
    <div class="fang_add mt10">
        {notempty name="$channelJoin"}
        <div class="item">
            <div class="item_l">{notempty name="$channelOrigin.join_must"}<b>*</b>{/notempty}关联{$channelJoin.ntitle}：</div>
            <div class="item_r">
                <input type="hidden" id="joinaid" name="joinaid" value="{$field.joinaid}" />
                <input type="text" name="join_title" id="join_title"  placeholder="丰祥花苑"  value="{$join_title}"/>
                <div class="input_div" id="input_div" style="display: none">
                </div>
            </div>
        </div>
        <script>
            var data_obj;
            $(function (){
                var searchurl = "{$searchurl}";
                autoSearch("join_title");
                function autoSearch(searchId) {
                    $("#" + searchId).autocomplete({
                        delay:300,      //触发时间
                        minLength:1,    //最小触发长度
                        source: function (request, response) {
                            $.ajax({
                                async: false,   //调用方式：同步
                                type: "POST",
                                url: searchurl,
                                dataType: "json",
                                data: {
                                    "keywords": request.term
                                },
                                success: function (data) {
                                    $(".input_div").empty();
                                    if (data.constructor === Object){
                                        data_obj = data;
                                        $.map(data,function (item,i) {
                                            var span = $('<span onclick="select_soption(this)" class="soption" data-id="'+i+'">'+item.title+'</span>');
                                            $(".input_div").append(span);
                                        });
                                        $(".input_div").show();
                                    }else{      //获取到空数据
                                        $(".input_div").hide();
                                    }
                                }
                                ,error:function (data) {
                                }
                            });
                        }
                    });
                }
            });
            function select_soption(obj) {
                var aid = $(obj).data('id');
                $("#joinaid").val(aid);
                $("#title").val(data_obj[aid]['title']);
                $("#join_title").val(data_obj[aid]['title']);
                $("#province_id").val(data_obj[aid]['province_id']);
                $("#city_id").val(data_obj[aid]['city_id']);
                $("#area_id").val(data_obj[aid]['area_id']);
                var map = "";
                if (data_obj[aid]['lng'] && data_obj[aid]['lat']){
                    map =  data_obj[aid]['lng']+","+data_obj[aid]['lat'];
                }
                $("#map").val(map);
                $("#address").val(data_obj[aid]['address']);
                $("#building_age").val(data_obj[aid]['building_age']);
                $("#property").val(data_obj[aid]['property']);

                $("#input_div").empty();
                $("#input_div").hide();

                set_city_list(data_obj[aid]['city_id']);
                set_area_list(data_obj[aid]['area_id']);
            }

        </script>
        {/notempty}
        <div class="item">
            <div class="item_l">{notempty name="$addonFieldExtList.province_id.ifrequire"}<b>*</b>{/notempty}期望区域：</div>
            <div class="item_r">
                <select name="province_id" id="province_id" onchange="province_ch()">
                    <option value="">省份</option>
                    {eju:volist name=':get_province_list()' id='vo'}
                    <option value="{$vo.id}" {eq name="$field.province_id" value="$vo.id" } selected {/eq}>{$vo.name}</option>
                    {/eju:volist}
                </select>
                <select name="city_id" id="city_id"  onchange="city_ch()">
                    <option value="">城市</option>
                </select>
                <select name="area_id" id="area_id">
                    <option value="">区域</option>
                </select>
            </div>
        </div>
        {notempty name="$addonFieldExtList['manage_type']['ifeditable']"}
        <div class="item">
            <div class="item_l">{notempty name="$addonFieldExtList.manage_type.ifrequire"}<b>*</b>{/notempty}{$addonFieldExtList['manage_type']['title']}：</div>
            <div class="item_r">
                <select  name="addonFieldSys[{$addonFieldExtList['manage_type']['name']|default=''}]">
                    {volist name="$addonFieldExtList['manage_type']['dfvalue']" id="v2"}
                    <option value="{$v2}" {if condition="isset($addonFieldExtList['manage_type']['trueValue']) AND in_array($v2, $addonFieldExtList['manage_type']['trueValue'])"}selected{/if}>{$v2}</option>
                    {/volist}
                </select>
            </div>
        </div>
        {/notempty}
        {notempty name="$addonFieldExtList['shop_type']['ifeditable']"}
        <div class="item">
            <div class="item_l">{notempty name="$addonFieldExtList.shop_type.ifrequire"}<b>*</b>{/notempty}{$addonFieldExtList['shop_type']['title']}：</div>
            <div class="item_r">
                <select  name="addonFieldSys[{$addonFieldExtList['shop_type']['name']|default=''}]">
                    {volist name="$addonFieldExtList['shop_type']['dfvalue']" id="v2"}
                    <option value="{$v2}" {if condition="isset($addonFieldExtList['shop_type']['trueValue']) AND in_array($v2, $addonFieldExtList['shop_type']['trueValue'])"}selected{/if}>{$v2}</option>
                    {/volist}
                </select>
            </div>
        </div>
        {/notempty}
        {notempty name="$addonFieldExtList['area']['ifeditable']"}
        <div class="item">
            <div class="item_l">{notempty name="$addonFieldExtList.area.ifrequire"}<b>*</b>{/notempty}{$addonFieldExtList['area']['title']}：</div>
            <div class="item_r">
                <select  name="addonFieldSys[{$addonFieldExtList['area']['name']|default=''}]">
                    {volist name="$addonFieldExtList['area']['dfvalue']" id="v2"}
                    <option value="{$v2}" {if condition="isset($addonFieldExtList['area']['trueValue']) AND in_array($v2, $addonFieldExtList['area']['trueValue'])"}selected{/if}>{$v2}</option>
                    {/volist}
                </select>
            </div>
        </div>
        {/notempty}
        {notempty name="$addonFieldExtList['sale_name']['ifeditable']"}
        <div class="item">
            <div class="item_l">{notempty name="$addonFieldExtList.sale_name.ifrequire"}<b>*</b>{/notempty}{$addonFieldExtList['sale_name']['title']}：</div>
            <div class="item_r">
                <input type="text" name="addonFieldSys[sale_name]" id="sale_name" value="{$users.true_name}"   placeholder="{$addonFieldExtList['sale_name']['remark']}" />
            </div>
        </div>
        {/notempty}
        {notempty name="$addonFieldExtList['sale_phone']['ifeditable']"}
        <div class="item">
            <div class="item_l">{notempty name="$addonFieldExtList.sale_phone.ifrequire"}<b>*</b>{/notempty}{$addonFieldExtList['sale_phone']['title']}：</div>
            <div class="item_r">
                <span><input type="text" name="addonFieldSys[sale_phone]" id="sale_phone" value="{$users.mobile}"   placeholder="{$addonFieldExtList['sale_phone']['remark']}"  /></span>
                {notempty name="$addonFieldExtList['phone_code']['ifeditable']"}
                <span>转</span>
                <span><input class="w80 tc" type="text" name="addonFieldSys[phone_code]" id="phone_code"  placeholder="{$addonFieldExtList['phone_code']['remark']}" value="{$addonFieldExtList['phone_code']['dfvalue']}"/></span>
                {/notempty}
            </div>
        </div>
        {/notempty}
        {notempty name="$addonFieldExtList['lease']['ifeditable']"}
        <div class="item">
            <div class="item_l">{notempty name="$addonFieldExtList.lease.ifrequire"}<b>*</b>{/notempty}{$addonFieldExtList['lease']['title']}：</div>
            <div class="item_r">
                <input type="text" name="addonFieldExt[lease]" id="lease" value="{$addonFieldExtList['lease']['dfvalue']}"   placeholder="{$addonFieldExtList['lease']['remark']}" />
            </div>
            <div class="item_unit">{$addonFieldExtList['lease']['dfvalue_unit']}</div>
        </div>
        {/notempty}
        {notempty name="$addonFieldExtList['certificate']['ifeditable']"}
        <div class="item">
            <div class="item_l">{notempty name="$addonFieldExtList.certificate.ifrequire"}<b>*</b>{/notempty}{$addonFieldExtList['certificate']['title']}：</div>
            <div class="item_r">
                <input type="text" name="addonFieldExt[certificate]" id="certificate" value="{$addonFieldExtList['certificate']['dfvalue']}"   placeholder="{$addonFieldExtList['certificate']['remark']}" />
            </div>
            <div class="item_unit">{$addonFieldExtList['certificate']['dfvalue_unit']}</div>
        </div>
        {/notempty}
        {notempty name="$addonFieldExtList['floors']['ifeditable']"}
        <div class="item">
            <div class="item_l">{notempty name="$addonFieldExtList.floors.ifrequire"}<b>*</b>{/notempty}{$addonFieldExtList['floors']['title']}：</div>
            <div class="item_r">
                <input type="text" name="addonFieldExt[floors]" id="floors" value="{$addonFieldExtList['floors']['dfvalue']}"   placeholder="{$addonFieldExtList['floors']['remark']}" />
            </div>
            <div class="item_unit">{$addonFieldExtList['floors']['dfvalue_unit']}</div>
        </div>
        {/notempty}
        <div class="item">
            <div class="item_l">{notempty name="$addonFieldExtList.area_min.ifrequire"}<b>*</b>{/notempty}意向面积:</div>
            <div class="item_r">
                <select name="addonFieldSys[area]" id="area" onchange="select_area(this)">
                    <option value="">请选择</option>
                    {volist name=":get_qiuzu_area_list()" id="v2"}
                    <option value="{$v2.value}" {if condition="isset($addonFieldExtList['area_min']['dfvalue']) AND ($v2['min'] eq $addonFieldExtList['area_min']['dfvalue']) AND isset($addonFieldExtList['area_max']['dfvalue']) AND ($v2['max'] eq $addonFieldExtList['area_max']['dfvalue'])"}selected{/if} >{$v2.name}</option>
                    {/volist}
                    <option value="0">其他</option>
                </select>
            </div>
        </div>
        <div class="item" id="area_value_div" style="display: none">
            <div class="item_l"></div>
            <div class="item_r">
                <span>
                  <input type="text" class="w80 tc" name="addonFieldSys[area_min]" id="area_min" value="{$addonFieldExtList['area_min']['dfvalue']}"  placeholder="{$addonFieldExtList['area_min']['remark']}" class="layui-input">
                </span>
                <span>--</span>
                <span>
                    <input type="text" class="w80 tc" name="addonFieldSys[area_max]" id="area_max" value="{$addonFieldExtList['area_max']['dfvalue']}"  placeholder="{$addonFieldExtList['area_max']['remark']}" class="layui-input">
                </span>
                {$addonFieldExtList['area_max']['dfvalue_unit']}
            </div>
        </div>
        <div class="item">
            <div class="item_l">{notempty name="$addonFieldExtList.price_min.ifrequire"}<b>*</b>{/notempty}意向租金:</div>
            <div class="item_r">
                <select name="addonFieldSys[price_type]" id="price_type" onchange="select_price_type(this)">
                    <option value="">请选择</option>
                    {volist name="$addonFieldExtList['price_type']['dfvalue']" id="v2"}
                    <option value="{$v2}" {if condition="isset($addonFieldExtList['price_type']['trueValue']) AND in_array($v2, $addonFieldExtList['price_type']['trueValue'])"}selected{/if}>{$v2}</option>
                    {/volist}
                </select>
            </div>
            <div class="item_r" id="price_select_div"  style="display: none">
                <select name="addonFieldSys[price]" id="price"  onchange="select_price(this)">
                    <option value="">请选择</option>
                    {volist name=":get_qiuzu_price_list()" id="v2"}
                    <option value="{$v2.value}" {if condition="isset($addonFieldExtList['price_min']['dfvalue']) AND ($v2['min'] eq $addonFieldExtList['price_min']['dfvalue']) AND isset($addonFieldExtList['price_max']['dfvalue']) AND ($v2['max'] eq $addonFieldExtList['price_max']['dfvalue'])"}selected{/if}>{$v2.name}</option>
                    {/volist}
                    <option value="0" >其他</option>
                </select>
            </div>
        </div>
        <div class="item"  >
            <div class="item_l"></div>
            <div class="item_r" id="price_value_div"   style="display: none">
                 <span>
                     <input type="text"  class="w80 tc" name="addonFieldSys[price_min]" id="price_min" value="{$addonFieldExtList['price_min']['dfvalue']}"  placeholder="{$addonFieldExtList['price_min']['remark']}" class="layui-input">
                </span>
                <span>--</span>
                <span>
                    <input type="text"  class="w80 tc" name="addonFieldSys[price_max]" id="price_max" value="{$addonFieldExtList['price_max']['dfvalue']}"  placeholder="{$addonFieldExtList['price_max']['remark']}" class="layui-input">
                </span>
            </div>
            <select name="addonFieldSys[price_units]" id="price_units">
                {volist name="$addonFieldExtList['price_units']['dfvalue']" id="v2"}
                <option value="{$v2}" {if condition="isset($addonFieldExtList['price_units']['trueValue']) AND in_array($v2, $addonFieldExtList['price_units']['trueValue'])"}selected{/if}>{$v2}</option>
                {/volist}
            </select>
        </div>

    {notempty name="$addonFieldExtList['transfer']['ifeditable']"}
    <div class="item">
        <div class="item_l">{notempty name="$addonFieldExtList.transfer.ifrequire"}<b>*</b>{/notempty}{$addonFieldExtList['transfer']['title']}：</div>
        <div class="item_r">
            <select  name="addonFieldSys[{$addonFieldExtList['transfer']['name']|default=''}]">
                {volist name="$addonFieldExtList['transfer']['dfvalue']" id="v2"}
                <option value="{$v2}" {if condition="isset($addonFieldExtList['transfer']['trueValue']) AND in_array($v2, $addonFieldExtList['transfer']['trueValue'])"}selected{/if}>{$v2}</option>
                {/volist}
            </select>
        </div>
    </div>
    {/notempty}
    {notempty name="$addonFieldExtList['supporting']['ifeditable']"}
    <div class="item">
        <div class="item_l">{notempty name="$addonFieldExtList.supporting.ifrequire"}<b>*</b>{/notempty}{$addonFieldExtList['supporting']['title']}：</div>
        <div class="item_r ">
            {volist name="$addonFieldExtList['supporting']['dfvalue']" id="v2"}
            <span class="mr10"><input type="checkbox"  onclick="checkbox_is_empty('addonFieldSys','supporting');" name="addonFieldSys[supporting][]"  {if condition="isset($addonFieldExtList['supporting']['trueValue']) AND in_array($v2, $addonFieldExtList['supporting']['trueValue'])"}checked="checked"{/if} value="{$v2}"/>{$v2}</span>
            {/volist}
            <input type="hidden" name="addonFieldSys[characteristic_eyempty]" value="{if condition="!empty($addonFieldExtList['supporting']['trueValue'])"}1{else /}0{/if}">
        </div>
    </div>
    {/notempty}
    <div class="footer-bt">
        <input type="hidden" name="aid" value="{$aid}">
        <a href="javascript:;" onclick="submit_fun()">确认提交</a>
    </div>
</form>


<script>
    $(document).ready(function(){
        var city_id = "{$field.city_id}";
        set_city_list(city_id);
        var area_id = "{$field.area_id}";
        set_area_list(area_id);
        area_value();
        price_select("{$addonFieldExtList.price_type.trueValue[0]}");
        price_value();
    });
    //光标离开楼盘地址编辑，自动获取坐标
    $("#address").on('blur',function(){
        var province_id = $("#province_id").val(),city_id = $("#city_id").val(),area_id = $("#area_id").val();
        var address = $(this).val();
        var url     = "{:url('home/Map/getLocationByAddress')}";
        var param = {
            province : province_id,
            city : city_id,
            area : area_id,
            address : address
        };
        $.get(url,param,function(res){
            if(res.code == 1)
            {
                $("#map").val(res.data.map);
            }
        });
    });
    var layui_index = layui.config({
        base: '__SKIN__/' //静态资源所在路径
        ,version: '{$version}'
    }).extend({
        index: 'lib/index' //主入口模块
    }).use(['index', 'form'], function(){
        var $ = layui.$
            ,element = layui.element
            ,layer = layui.layer
            ,form = layui.form;

        element.render();
        //监听提交
        form.on('submit(formSubmit)', function(data){
            var load = layer_loading();
            data.field._ajax = 1;
            $('textarea[class*="ckeditor"]').each(function(index, item){
                data.field[item.name] = item.value;
            });
            $.ajax({
                type : 'post',
                url : "{:url('Qiuzu/add')}",
                data : data.field,
                dataType : 'json',
                success : function(res){
                    layer.close(load); //关闭loading
                    if(res.code == 1){
                        parent.window.location.href = res.url;
                    }else{
                        layer.msg(res.msg, {icon: 2,time: 2000});
                    }
                },
                error: function(e){
                    layer.close(load); //关闭loading
                    showErrorAlert();
                }
            });
            return false;
        });

    });
    //提交
    function submit_fun(){
        var load = layer_loading();
        $.ajax({
            type : 'post',
            url : "{:url('Qiuzu/add')}",
            data : $("#post_form").serialize(),
            dataType : 'json',
            success : function(res){
                layer.close(load); //关闭loading
                if(res.code == 1){
                    parent.window.location.href = res.url;
                }else{
                    layer.msg(res.msg, {icon: 2,time: 2000});
                }
            },
            error: function(e){
                layer.close(load); //关闭loading
                showErrorAlert();
            }
        });
        return false;
    }
    //选择省份
    function province_ch(){
        set_city_list(0);
        set_area_list(0);
    }
    //选择城市
    function city_ch(){
        set_area_list(0);
    }
    //标注地图位置
    function set_map()
    {
        var province = $("#province_id").val();
        var city = $("#city_id").val();
        var area = $("#area_id").val();
        if(city==='0' || city === '' || city === null)
        {
            layer.msg('请选择城市',{icon:2});
            return false;
        }
        var map = $("#map").val();
        var url = "{:url('home/Map/updateLocation')}&province="+province+"&city="+city+"&area="+area+"&map="+map;
        //iframe窗
        var iframes = layer.open({
            type: 2,
            title: '标注地图',
            fixed: true, //不固定
            shadeClose: false,
            shade: 0.3,
            content: url
        });
        layer.full(iframes);
    }
    //自动获取城市列表
    function set_city_list(cityid) {
        var pid =  $("#province_id").val();
        $.ajax({
            url: "{:url('Archives/ajax_get_region')}",
            type: 'POST',
            dataType: 'JSON',
            async: false,
            data: {pid:pid,_ajax:1},
            success: function(res){
                if (res.code === 1){
                    $("#city_id").empty();
                    $("#city_id").prepend(res.msg);
                    if (cityid > 0){
                        $("#city_id").val(cityid);
                    }
                }
            },
            error: function(e){
                showErrorMsg();
                return false;
            }
        });
    }
    //自动获取区域
    function set_area_list(areaid) {
        var pid =  $("#city_id").val();
        $.ajax({
            url: "{:url('Archives/ajax_get_region')}",
            type: 'POST',
            dataType: 'JSON',
            async: false,
            data: {pid:pid,level:3,_ajax:1},
            success: function(res){
                if (res.code === 1){
                    $("#area_id").empty();
                    $("#area_id").prepend(res.msg);
                    if (areaid > 0){
                        $("#area_id").val(areaid);
                    }
                    if (res.data.isempty == 1){
                        $("#area_div").hide();
                    }else{
                        $("#area_div").show();
                    }
                }
            },
            error: function(e){
                showErrorMsg();
                return false;
            }
        });
    }
    //上传相册前判断
    function ershou_photo_upload(){
        return true;
    }
    // 上传之后删除组图input
    function ClearPicArr(obj,path)
    {
        $(obj).parent().remove(); // 删除完服务器的, 再删除 html上的图片
        $.ajax({
            type:'POST',
            url:"{:url('Uploadify/delupload')}",
            data:{action:"del", filename:path},
            success:function(){}
        });
    }
    // 查看大图
    function Images(links){
        var max_width = 650;
        var max_height = 350;
        var img = "<img src='"+links+"'/>";
        $(img).load(function() {
            width  = this.width;
            height = this.height;
            if (width > height) {
                if (width > max_width) {
                    width = max_width;
                }
                width += 'px';
            } else {
                width = 'auto';
            }
            if (width < height) {
                if (height > max_height) {
                    height = max_height;
                }
                height += 'px';
            } else {
                height = 'auto';
            }
            var links_img = "<img style='width:"+width+";height:"+height+";' src="+links+">";
            layer.open({
                type: 1,
                title: false,
                closeBtn: true,
                shadeClose:true,
                area: [width, height],
                skin: 'layui-layer-nobg', //没有背景色
                content: links_img
            });
        });
    }
    // 图集相册的拖动排序相关 js
    $( ".sort-list" ).sortable({
        start: function( event, ui) {
        }
        ,stop: function( event, ui ) {
        }
    });
    $( ".sort-list" ).disableSelection();

    // 上传图集相册回调函数
    function ershou_photo_upload_call_back(pathObj){
        if (Array.isArray(pathObj)){
            var paths = pathObj;
        }else{
            var paths = [pathObj.url];
        }
        var last_div = $(".images_upload_tpl").html();
        for (var i=0;i<paths.length ;i++){
            $(".images-upload:eq(0)").before(last_div);  // 插入一个 新图片
            // 修改他的链接地址
            $(".images-upload:eq(0)").find('span:eq(0)').attr('onclick',"Images('"+paths[i]+"');");
            // 修改他的图片路径
            $(".images-upload:eq(0)").find('img').attr('src',paths[i]);
            // 处理图片路径及隐藏域
            $(".images-upload:eq(0)").find('input:eq(0)').attr('name','photo_id[]').attr('value','');
            $(".images-upload:eq(0)").find('input:eq(1)').attr('name','photo_pic[]').attr('value',paths[i]);
            $(".images-upload:eq(0)").find('input:eq(2)').attr('name','photo_title[]').attr('value','');
            $(".images-upload:eq(0)").find('a:eq(0)').attr('onclick',"ClearPicArr(this,'"+paths[i]+"')").html("删除");
        }
    }
</script>
<script type="text/javascript">
    //点击展开更多添加项
    $(".more-down").click(function(){
        $(".fang_more").toggle();
        if($(this).text() == "【点击展开】选填部分，建议填写"){
            $(this).text("【点击隐藏】选填部分，建议填写")
        }else{
            $(this).text("【点击展开】选填部分，建议填写")
        }
    })
    function select_area(obj){
        console.log(obj.value);
        if(obj.value == '0'){
            $("#area_min").val("");
            $("#area_max").val("");
            $("#area_value_div").show();
        }else{
            var arr = obj.value.split(',');
            $("#area_min").val(arr[0]);
            $("#area_max").val(arr[1]);
            $("#area_value_div").hide();
        }
    }
    //选择租金模式
    function select_price_type(obj){
        if(obj.value == '月租金'){
            $("#price_select_div").show();
            $("#price_value_div").hide();
        }else if(obj.value == '日租金'){
            $("#price_select_div").hide();
            $("#price_value_div").show();
        }else{
            $("#price_select_div").hide();
            $("#price_value_div").hide();
        }
    }
    //选择租金范围
    function select_price(obj){
        if(obj.value == '0'){
            $("#price_min").val("");
            $("#price_max").val("");
            $("#price_value_div").show();
        }else{
            var arr = obj.value.split(',');
            $("#price_min").val(arr[0]);
            $("#price_max").val(arr[1]);
            $("#price_value_div").hide();
        }
    }
    //判断是否显示填空区域
    function area_value(){
        var area = $("#area").val();
        if(area == '' || area == '0'){
            $("#area_value_div").show();
            $("#area").val(0);
        }else{
            $("#area_value_div").hide();
        }
    }
    function price_select(data){
        if(data == '月租金'){
            $("#price_select_div").show();
            $("#price_value_div").hide();
        }else if(data == '日租金'){
            $("#price_select_div").hide();
            $("#price_value_div").show();
        }else{
            $("#price_select_div").hide();
            $("#price_value_div").hide();
        }
    }
    function price_value(){
        var price = $("#price").val();
        if(price == '' || price == '0'){
            $("#price_value_div").show();
            $("#price").val(0);
        }else{
            $("#price_value_div").hide();
        }
    }
</script>
</body>
</html>
